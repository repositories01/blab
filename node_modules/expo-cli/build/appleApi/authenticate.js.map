{"version":3,"sources":["../../src/appleApi/authenticate.ts"],"names":["APPLE_IN_HOUSE_TEAM_TYPE","authenticate","options","appleId","appleIdPassword","_requestAppleIdCreds","teams","fastlaneSession","travelingFastlane","pipeStdout","chalk","green","team","_chooseTeam","teamId","err","rawDump","match","red","anotherPromptResult","_promptForAppleId","firstAttempt","previousAppleId","_getAppleIdFromParams","passedAppleIdPassword","process","env","EXPO_APPLE_PASSWORD","undefined","Error","wrap","stdout","columns","here","bold","grey","promptAppleId","type","name","message","validate","nonEmptyInput","default","nonInteractiveHelp","userProvidedTeamId","length","foundTeam","find","_formatTeam","log","warn","choices","map","i","value","id","inHouse","toLowerCase"],"mappings":"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","sourcesContent":["import chalk from 'chalk';\nimport terminalLink from 'terminal-link';\nimport wordwrap from 'wordwrap';\n\nimport log from '../log';\nimport prompt from '../prompt';\nimport { nonEmptyInput } from '../validators';\nimport { runAction, travelingFastlane } from './fastlane';\n\nconst APPLE_IN_HOUSE_TEAM_TYPE = 'in-house';\n\nexport type Options = {\n  appleIdPassword?: string;\n  appleId?: string;\n  teamId?: string;\n};\n\ntype AppleCredentials = {\n  appleIdPassword: string;\n  appleId: string;\n};\n\nexport type Team = {\n  id: string;\n  name?: string;\n  inHouse?: boolean;\n};\n\ntype FastlaneTeam = {\n  name: string;\n  teamId: string;\n  status: string;\n  type: string;\n};\n\nexport type AppleCtx = {\n  appleId: string;\n  appleIdPassword: string;\n  team: Team;\n  fastlaneSession: string;\n};\n\nexport async function authenticate(options: Options = {}): Promise<AppleCtx> {\n  const { appleId, appleIdPassword } = await _requestAppleIdCreds(options);\n  log(`Authenticating to Apple Developer Portal...`); // use log instead of spinner in case we need to prompt user for 2fa\n  try {\n    const { teams, fastlaneSession } = await runAction(\n      travelingFastlane.authenticate,\n      [appleId, appleIdPassword],\n      {\n        pipeStdout: true,\n      }\n    );\n    log(chalk.green('Authenticated with Apple Developer Portal successfully!'));\n    const team = await _chooseTeam(teams, options.teamId);\n    return { appleId, appleIdPassword, team, fastlaneSession };\n  } catch (err) {\n    if (err.rawDump?.match(/Invalid username and password combination/)) {\n      log(chalk.red('Invalid username and password combination, try again.'));\n      const anotherPromptResult = await _promptForAppleId({\n        firstAttempt: false,\n        previousAppleId: appleId,\n      });\n      return authenticate({ ...options, ...anotherPromptResult });\n    }\n    log(chalk.red('Authentication with Apple Developer Portal failed!'));\n    throw err;\n  }\n}\n\nasync function _requestAppleIdCreds(options: Options): Promise<AppleCredentials> {\n  return _getAppleIdFromParams(options) || (await _promptForAppleId());\n}\n\nfunction _getAppleIdFromParams({ appleId, appleIdPassword }: Options): AppleCredentials | null {\n  const passedAppleIdPassword = appleId\n    ? appleIdPassword || process.env.EXPO_APPLE_PASSWORD\n    : undefined;\n\n  // none of the apple id params were set, assume user has no intention of passing it in\n  if (!appleId) {\n    return null;\n  }\n\n  // partial apple id params were set, assume user has intention of passing it in\n  if (!(appleId && passedAppleIdPassword)) {\n    throw new Error(\n      'In order to provide your Apple ID credentials, you must set the --apple-id flag and set the EXPO_APPLE_PASSWORD environment variable.'\n    );\n  }\n\n  return {\n    appleId: appleId as string,\n    appleIdPassword: passedAppleIdPassword as string,\n  };\n}\n\nasync function _promptForAppleId({\n  firstAttempt = true,\n  previousAppleId,\n}: { firstAttempt?: boolean; previousAppleId?: string } = {}): Promise<AppleCredentials> {\n  if (firstAttempt) {\n    const wrap = wordwrap(process.stdout.columns || 80);\n    log(\n      wrap(\n        'Please enter your Apple Developer Program account credentials. ' +\n          'These credentials are needed to manage certificates, keys and provisioning profiles ' +\n          `in your Apple Developer account.`\n      )\n    );\n\n    // https://docs.expo.io/distribution/security/#apple-developer-account-credentials\n    const here = terminalLink('here', 'https://bit.ly/2VtGWhU');\n    log(wrap(chalk.bold(`The password is only used to authenticate with Apple and never stored`)));\n    log(wrap(chalk.grey(`Learn more ${here}`)));\n  }\n\n  const { appleId: promptAppleId } = await prompt(\n    {\n      type: 'input',\n      name: 'appleId',\n      message: `Apple ID:`,\n      validate: nonEmptyInput,\n      ...(previousAppleId && { default: previousAppleId }),\n    },\n    {\n      nonInteractiveHelp: 'Pass your Apple ID using the --apple-id flag.',\n    }\n  );\n  const { appleIdPassword } = await prompt(\n    {\n      type: 'password',\n      name: 'appleIdPassword',\n      message: () => `Password (for ${promptAppleId}):`,\n      validate: nonEmptyInput,\n    },\n    {\n      nonInteractiveHelp:\n        'Pass your Apple ID password using the EXPO_APPLE_PASSWORD environment variable',\n    }\n  );\n  return { appleId: promptAppleId, appleIdPassword };\n}\n\nasync function _chooseTeam(teams: FastlaneTeam[], userProvidedTeamId?: string): Promise<Team> {\n  if (teams.length === 0) {\n    throw new Error(`You have no team associated with your Apple account, cannot proceed.\n(Do you have a paid Apple Developer account?)`);\n  }\n\n  if (userProvidedTeamId) {\n    const foundTeam = teams.find(({ teamId }) => teamId === userProvidedTeamId);\n    if (foundTeam) {\n      log(`Using Apple Team with ID: ${userProvidedTeamId}`);\n      return _formatTeam(foundTeam);\n    } else {\n      log.warn(`Your account is not associated with Apple Team with ID: ${userProvidedTeamId}`);\n    }\n  }\n\n  if (teams.length === 1) {\n    const [team] = teams;\n    log(`Only 1 team associated with your account, using Apple Team with ID: ${team.teamId}`);\n    return _formatTeam(team);\n  } else {\n    log(`You have ${teams.length} teams associated with your account`);\n    const choices = teams.map((team, i) => ({\n      name: `${i + 1}) ${team.teamId} \"${team.name}\" (${team.type})`,\n      value: team,\n    }));\n    const { team } = await prompt(\n      {\n        type: 'list',\n        name: 'team',\n        message: 'Which team would you like to use?',\n        choices,\n      },\n      {\n        nonInteractiveHelp: 'Pass in your Apple Team ID using the --team-id flag.',\n      }\n    );\n    return _formatTeam(team);\n  }\n}\n\nfunction _formatTeam({ teamId, name, type }: FastlaneTeam): Team {\n  return {\n    id: teamId,\n    name: `${name} (${type})`,\n    inHouse: type.toLowerCase() === APPLE_IN_HOUSE_TEAM_TYPE,\n  };\n}\n"],"file":"authenticate.js"}