{"version":3,"sources":["../../../../src/commands/eas-build/status/action.ts"],"names":["statusAction","projectDir","platform","status","buildId","Error","platforms","Object","values","BuildCommandPlatform","statuses","BuildStatus","includes","map","p","log","chalk","bold","join","s","user","UserManager","ensureLoggedInAsync","exp","accountName","owner","username","projectName","slug","projectId","client","ApiV2","clientForUser","spinner","start","builds","buildStatus","getAsync","undefined","params","ANDROID","IOS","e","fail","message","length","succeed","printBuildTable","headers","colWidths","refactoredBuilds","build","buildUrl","artifacts","started","Intl","DateTimeFormat","year","month","day","hour","minute","format","Date","createdAt","replace","artifact","terminalLink","slice","buildTable","console"],"mappings":"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","sourcesContent":["import { ProjectConfig, getConfig } from '@expo/config';\nimport { ApiV2, User, UserManager } from '@expo/xdl';\nimport ora from 'ora';\n\nimport log from '../../../log';\nimport { ensureProjectExistsAsync } from '../../../projects';\nimport { printTableJsonArray } from '../../utils/cli-table';\nimport { Build, BuildCommandPlatform, BuildStatus } from '../types';\n\ninterface BuildStatusOptions {\n  platform: BuildCommandPlatform;\n  buildId?: string;\n  status?: BuildStatus;\n}\n\nasync function statusAction(\n  projectDir: string,\n  { platform, status, buildId }: BuildStatusOptions\n): Promise<void> {\n  if (buildId) {\n    if (platform) {\n      throw new Error('-p/--platform cannot be specified if --build-id is specified.');\n    }\n\n    if (status) {\n      throw new Error('-s/--status cannot be specified if --build-id is specified.');\n    }\n  } else {\n    const platforms = Object.values(BuildCommandPlatform);\n    const statuses = Object.values(BuildStatus);\n\n    if (platform && !platforms.includes(platform)) {\n      throw new Error(\n        `-p/--platform needs to be one of: ${platforms.map(p => log.chalk.bold(p)).join(', ')}`\n      );\n    }\n\n    if (status && !statuses.includes(status)) {\n      throw new Error(\n        `-s/--status needs to be one of: ${statuses.map(s => log.chalk.bold(s)).join(', ')}`\n      );\n    }\n  }\n\n  const user: User = await UserManager.ensureLoggedInAsync();\n  const { exp }: ProjectConfig = getConfig(projectDir);\n\n  const accountName = exp.owner || user.username;\n  const projectName = exp.slug;\n\n  const projectId = await ensureProjectExistsAsync(user, {\n    accountName,\n    projectName,\n  });\n\n  const client = ApiV2.clientForUser(user);\n\n  const spinner = ora().start('Fetching build history...');\n\n  let builds: Build[] | undefined;\n\n  try {\n    if (buildId) {\n      const buildStatus = await client.getAsync(`projects/${projectId}/builds/${buildId}`);\n      builds = buildStatus ? [buildStatus] : undefined;\n    } else {\n      const params = {\n        ...([BuildCommandPlatform.ANDROID, BuildCommandPlatform.IOS].includes(platform)\n          ? { platform }\n          : null),\n        ...(status ? { status } : null),\n      };\n\n      const buildStatus = await client.getAsync(`projects/${projectId}/builds`, params);\n      builds = buildStatus?.builds;\n    }\n  } catch (e) {\n    spinner.fail(e.message);\n    throw new Error('Error getting current build status for this project.');\n  }\n\n  if (!builds?.length) {\n    spinner.succeed('No currently active or previous builds for this project.');\n  } else {\n    spinner.succeed(`Found ${builds.length} builds for this project.`);\n    printBuildTable(builds);\n  }\n}\n\nfunction printBuildTable(builds: Build[]) {\n  const headers = ['started', 'platform', 'status', 'artifact'];\n  const colWidths = [24, 10, 13, 41];\n\n  const refactoredBuilds = builds.map(build => {\n    const buildUrl = build.artifacts?.buildUrl;\n\n    return {\n      started: new Intl.DateTimeFormat('en', {\n        year: 'numeric',\n        month: 'short',\n        day: '2-digit',\n        hour: '2-digit',\n        minute: '2-digit',\n      }).format(new Date(build.createdAt)),\n      platform: build.platform,\n      status: build.status.replace(/-/g, ' '),\n      artifact: buildUrl\n        ? // Trim the URL here, otherwise if printTableJsonArray trims it, it incorrectly removes the escape to end the link\n          // Which makes everything in the terminal a link after printing the table\n          log.terminalLink(buildUrl.length > 38 ? `${buildUrl.slice(0, 38)}â€¦` : buildUrl, buildUrl)\n        : 'not available',\n    };\n  });\n\n  const buildTable = printTableJsonArray(headers, refactoredBuilds, colWidths);\n\n  console.log(buildTable);\n}\n\nexport default statusAction;\n"],"file":"action.js"}