{"version":3,"sources":["../../../src/credentials/provider/iOSCredentialsProvider.ts"],"names":["iOSCredentialsProvider","constructor","projectDir","app","Context","initAsync","ctx","init","nonInteractive","hasRemoteAsync","distCert","ios","getDistCert","provisioningProfile","getProvisioningProfile","hasLocalAsync","credentialsJson","fileExistsAsync","readIosAsync","_","isLocalSyncedAsync","remote","local","Promise","all","getRemoteAsync","getLocalAsync","r","l","distributionCertificate","certP12","certPassword","getCredentialsAsync","src","CredentialsSource","LOCAL","REMOTE","SetupIosBuildCredentials","Error"],"mappings":"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","sourcesContent":["import { CredentialsSource } from '../../easJson';\nimport { AppLookupParams } from '../api/IosApi';\nimport { Context } from '../context';\nimport { credentialsJson } from '../local';\nimport { runCredentialsManager } from '../route';\nimport { SetupIosBuildCredentials } from '../views/SetupIosBuildCredentials';\nimport { CredentialsProvider } from './provider';\n\nexport interface iOSCredentials {\n  provisioningProfile: string;\n  distributionCertificate: {\n    certP12: string;\n    certPassword: string;\n  };\n}\n\nexport default class iOSCredentialsProvider implements CredentialsProvider {\n  public readonly platform = 'ios';\n  private readonly ctx = new Context();\n  private credentials?: iOSCredentials;\n\n  constructor(private projectDir: string, private app: AppLookupParams) {}\n\n  public async initAsync() {\n    await this.ctx.init(this.projectDir, {\n      nonInteractive: this.ctx.nonInteractive,\n    });\n  }\n\n  public async hasRemoteAsync(): Promise<boolean> {\n    const distCert = await this.ctx.ios.getDistCert(this.app);\n    const provisioningProfile = await this.ctx.ios.getProvisioningProfile(this.app);\n    return !!(distCert && provisioningProfile);\n  }\n\n  public async hasLocalAsync(): Promise<boolean> {\n    if (!(await credentialsJson.fileExistsAsync(this.projectDir))) {\n      return false;\n    }\n    try {\n      await credentialsJson.readIosAsync(this.projectDir);\n      return true;\n    } catch (_) {\n      return false;\n    }\n  }\n\n  public async isLocalSyncedAsync(): Promise<boolean> {\n    try {\n      const [remote, local] = await Promise.all([this.getRemoteAsync(), this.getLocalAsync()]);\n      const r = remote;\n      const l = local;\n      return !!(\n        r.provisioningProfile === l.provisioningProfile &&\n        r.distributionCertificate.certP12 === l.distributionCertificate.certP12 &&\n        r.distributionCertificate.certPassword === l.distributionCertificate.certPassword\n      );\n    } catch (_) {\n      return false;\n    }\n  }\n\n  public async getCredentialsAsync(\n    src: CredentialsSource.LOCAL | CredentialsSource.REMOTE\n  ): Promise<iOSCredentials> {\n    switch (src) {\n      case CredentialsSource.LOCAL:\n        return await this.getLocalAsync();\n      case CredentialsSource.REMOTE:\n        return await this.getRemoteAsync();\n    }\n  }\n\n  private async getLocalAsync(): Promise<iOSCredentials> {\n    return await credentialsJson.readIosAsync(this.projectDir);\n  }\n  private async getRemoteAsync(): Promise<iOSCredentials> {\n    await runCredentialsManager(this.ctx, new SetupIosBuildCredentials(this.app));\n    const distCert = await this.ctx.ios.getDistCert(this.app);\n    if (!distCert) {\n      throw new Error('Missing distribution certificate'); // shouldn't happen\n    }\n    const provisioningProfile = await this.ctx.ios.getProvisioningProfile(this.app);\n    if (!provisioningProfile) {\n      throw new Error('Missing provisioning profile'); // shouldn't happen\n    }\n    return {\n      provisioningProfile: provisioningProfile.provisioningProfile,\n      distributionCertificate: {\n        certP12: distCert.certP12,\n        certPassword: distCert.certPassword,\n      },\n    };\n  }\n}\n"],"file":"iOSCredentialsProvider.js"}